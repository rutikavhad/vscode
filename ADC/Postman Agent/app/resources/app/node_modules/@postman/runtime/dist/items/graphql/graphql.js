"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getOperationType = getOperationType;
exports.inferProtocol = inferProtocol;
const graphql_1 = require("graphql");
const key_values_1 = require("../../lib/key-values");
const urls_1 = require("../../lib/urls");
function getOperationType(query, operationName) {
    let operationType = 'query';
    if (query) {
        try {
            (0, graphql_1.visit)((0, graphql_1.parse)(query), {
                OperationDefinition(node) {
                    if (!operationName || operationName === node.name?.value) {
                        operationType = node.operation;
                        return graphql_1.BREAK;
                    }
                    return;
                },
            });
        }
        catch (_error) {
            // It's ok to send invalid queries, ignore errors
        }
    }
    return operationType;
}
function inferProtocol(request) {
    const { protocol } = (0, urls_1.parseURL)(request.url);
    const accept = (0, key_values_1.getValue)(request.headers, 'accept', { caseInsensitive: true });
    const operationType = getOperationType(request.query, request.operationName);
    if (protocol === 'ws:' || protocol === 'wss:') {
        return ['websocket', operationType];
    }
    if (accept === 'text/event-stream') {
        return ['sse', operationType];
    }
    if (operationType === 'subscription') {
        return ['websocket', operationType];
    }
    return ['http', operationType];
}
//# sourceMappingURL=graphql.js.map