"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.forwardPlatformEventsToRun = forwardPlatformEventsToRun;
const streams_1 = require("./streams");
// Helper for dealing with platform channels and forwarding their events to a run
// To be used within plugins
async function forwardPlatformEventsToRun({ run, event, callPlatform, errorType, }) {
    if (run.context.execution?.dryRun) {
        return;
    }
    // callPlatform should call in to the platform itself, returning a channel
    const channel = await callPlatform();
    run.waitUntil(async () => {
        // Handle incoming events from the connection
        run.subscribe((event) => {
            if (event.type === 'run:cancel') {
                run.cancel();
            }
        });
        // Forward generically typed events to the run
        try {
            for await (const event of (0, streams_1.values)(channel.readable)) {
                run.enqueue(event);
            }
        }
        catch (channelError) {
            run.error({
                type: errorType,
                payload: {
                    message: channelError instanceof Error ?
                        channelError.message
                        : 'Channel error',
                    source: event.type,
                },
            });
        }
    });
}
//# sourceMappingURL=platform.js.map