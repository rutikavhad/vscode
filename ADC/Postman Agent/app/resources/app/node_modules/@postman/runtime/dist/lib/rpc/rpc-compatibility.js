"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.proxy = proxy;
const _1 = require(".");
const streams_1 = require("../streams");
function proxy(client) {
    return new Proxy({}, {
        get(_target, namespace) {
            return new Proxy({}, {
                get(_target, name) {
                    return async (...args) => {
                        const { remote } = await client.invoke('platform.execute', {
                            path: [namespace, name],
                            args,
                        });
                        const proxy = remote.toProxy(['write', 'cancel']);
                        return new _1.Channel(async ({ incoming, outgoing }) => {
                            proxy.on('data', (data) => {
                                incoming.enqueue(data);
                            });
                            proxy.on('#error', (error) => {
                                incoming.error(error);
                            });
                            proxy.on('#close', () => {
                                try {
                                    incoming.close();
                                }
                                catch (_error) {
                                    // (ignore already closed errors)
                                }
                            });
                            remote.onCleanup((error) => {
                                if (error) {
                                    incoming.error(error);
                                }
                            });
                            incoming.signal.addEventListener('abort', () => {
                                proxy.cancel();
                            });
                            for await (const data of (0, streams_1.iterate)(outgoing)) {
                                proxy.write(data);
                            }
                            proxy.cancel();
                        });
                    };
                },
            });
        },
    });
}
//# sourceMappingURL=rpc-compatibility.js.map