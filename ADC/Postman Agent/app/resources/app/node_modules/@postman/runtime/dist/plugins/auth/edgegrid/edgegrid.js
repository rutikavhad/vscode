"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateEdgeGridAuthorization = generateEdgeGridAuthorization;
exports.canonicalizeHeaders = canonicalizeHeaders;
exports.formatTimestamp = formatTimestamp;
const hashing_1 = require("../../../lib/crypto/hashing");
/**
 * Generate an Authorization header for EdgeGrid
 */
async function generateEdgeGridAuthorization(parameters) {
    const signingKey = await (0, hashing_1.computeSignedHash)(parameters.clientSecret, parameters.timestamp, 'SHA-256', 'base64');
    const authorizationHeader = `EG1-HMAC-SHA256 client_token=${parameters.clientToken};access_token=${parameters.accessToken};timestamp=${parameters.timestamp};nonce=${parameters.nonce};`;
    const signature = await (0, hashing_1.computeSignedHash)(signingKey, [
        parameters.method,
        parameters.url.protocol.slice(0, -1),
        parameters.baseURL ?? parameters.url.host,
        parameters.url.path ?? '/',
        canonicalizeHeaders(parameters.headersToSign, parameters.headers),
        parameters.bodyHash ?? '',
        authorizationHeader,
    ].join('\t'), 'SHA-256', 'base64');
    return `${authorizationHeader}signature=${signature}`;
}
/**
 * Normalize headers and combine them into tab-separated string
 */
function canonicalizeHeaders(headersToSign, headers) {
    const formattedHeaders = [];
    for (const headerName of headersToSign) {
        if (typeof headerName !== 'string')
            continue;
        const key = headerName.trim().toLowerCase();
        const value = headers[key];
        if (typeof value !== 'string' || value === '')
            continue;
        formattedHeaders.push(`${key}:${value.trim().replace(/\s+/g, ' ')}`);
    }
    return formattedHeaders.join('\t');
}
/**
 * Use special date formatting for timestamps in EdgeGrid
 */
function formatTimestamp(date) {
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    const hours = String(date.getUTCHours()).padStart(2, '0');
    const minutes = String(date.getUTCMinutes()).padStart(2, '0');
    const seconds = String(date.getUTCSeconds()).padStart(2, '0');
    return `${year}${month}${day}T${hours}:${minutes}:${seconds}+0000`;
}
//# sourceMappingURL=edgegrid.js.map