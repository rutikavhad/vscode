"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.proxy = void 0;
const proxy_1 = require("./proxy");
exports.proxy = {
    name: 'proxy',
    resolved: {
        async 'http:send-request'(event, run) {
            await handleProxy(run, event.payload.url, (proxy) => {
                run.patch(event, (payload) => {
                    payload.settings.proxy = proxy;
                });
            });
        },
        async 'grpc:invoke'(event, run) {
            await handleProxy(run, event.payload.url, (proxy) => {
                run.patch(event, (payload) => {
                    payload.settings ??= {};
                    payload.settings.proxy = proxy;
                });
            });
        },
        async 'mcp:request-connect'(event, run) {
            if (event.payload.transport === 'sse') {
                await handleProxy(run, event.payload.url, (proxy) => {
                    run.patch(event, (payload) => {
                        if (payload.settings) {
                            payload.settings = { ...payload.settings, proxy };
                        }
                        else {
                            payload.settings = { proxy, ca: null };
                        }
                    });
                });
            }
        },
    },
};
async function handleProxy(run, url, patchCallback) {
    const { useEnvironment = true } = run.context.proxy ?? {};
    const proxy = await (0, proxy_1.resolveProxy)(url, run.context.proxy, run.runtime.platform?.proxy);
    patchCallback(proxy ?? useEnvironment);
}
//# sourceMappingURL=proxy-plugin.js.map