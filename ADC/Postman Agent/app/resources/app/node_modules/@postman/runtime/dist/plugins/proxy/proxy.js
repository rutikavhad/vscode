"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveProxy = resolveProxy;
const postman_collection_1 = require("postman-collection");
const async_iterable_1 = require("../../lib/async-iterable");
const streams_1 = require("../../lib/streams");
async function resolveProxy(url, context = {}, platform) {
    if (!context && !platform)
        return null;
    const { definitions = [], useSystem = true, useEnvironment = true } = context;
    const list = new postman_collection_1.ProxyConfigList({}, definitions);
    const proxyURL = list.resolve(url)?.getProxyUrl();
    if (proxyURL)
        return proxyURL;
    if (!platform || (!useSystem && !useEnvironment))
        return null;
    const channel = await platform?.resolveProxy?.(url, {
        useSystem,
        useEnvironment,
    });
    if (!channel)
        return null;
    const result = await (0, async_iterable_1.collect)((0, async_iterable_1.take)((0, streams_1.values)(channel.readable), 1));
    return result[0] ?? null;
}
//# sourceMappingURL=proxy.js.map