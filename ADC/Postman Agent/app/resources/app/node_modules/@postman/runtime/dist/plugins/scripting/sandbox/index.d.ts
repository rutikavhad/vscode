import { ItemContext } from './sandbox-types';
import type { ExecutionContext, SandboxContext } from 'postman-sandbox';
import type { Events } from '@postman/runtime.models';
import type { Request as PMRequest, Response as PMResponse } from 'postman-collection';
import type { SandboxAPIs } from 'postman-sandbox';
import { MaybePromise } from '../../../lib/promises';
import type { Run } from '../../../run';
import type { Vault } from '../../variables';
import { EventEmitter } from '../utils/event-emitter';
type EventHandler = ElementType<Events> & {
    owner?: string;
};
type ElementType<T> = T extends (infer U)[] ? U : T;
type CustomEvent<T = null> = {
    payload: T;
};
interface Source {
    executionId?: string;
    eventId?: string;
    eventName?: string;
    owner?: string;
}
type ExecutionEventMap = {
    'scripting:execute': CustomEvent<{
        source: Source;
    }>;
    'scripting:complete': CustomEvent<{
        source: Source;
        result?: ExecutionContext;
    }>;
    'scripting:assertion': CustomEvent<{
        source: Source;
        assertions?: unknown;
    }>;
    'scripting:console': CustomEvent<{
        source: Source;
        level: 'log' | 'info' | 'warn' | 'error';
        messages: unknown;
    }>;
    'scripting:error': CustomEvent<{
        source: Source;
        error: Error | null;
    }>;
    'extension:events:skip-request': CustomEvent<{
        source: Source;
    }>;
};
interface ExecutionConstructorOpts {
    signal?: AbortSignal;
    event: EventHandler;
    itemContext?: ItemContext;
    variableProvider: () => MaybePromise<Pick<ExecutionContext, 'collectionVariables' | '_variables' | 'globals' | 'environment'>>;
    vault?: Vault;
    script?: string;
    disabledAPIs?: SandboxAPIs[];
    sendRequestProvider: (request: PMRequest) => Promise<PMResponse | undefined>;
    packageProvider?: ({ packages, }: {
        packages: Record<string, {
            id: string;
        }>;
    }) => Promise<Record<string, {
        data: string;
    }>>;
}
declare class Execution extends EventEmitter<ExecutionEventMap> {
    readonly id: `${string}-${string}-${string}-${string}-${string}`;
    private completionPromise;
    private readonly signal?;
    private readonly variableProvider;
    private readonly sendRequestProvider;
    private readonly disabledAPIs?;
    readonly event: EventHandler;
    private cleanups;
    private readonly itemContext?;
    private readonly vault?;
    private readonly packageProvider?;
    constructor(opts: ExecutionConstructorOpts);
    get completed(): Promise<void>;
    dispose(): void;
    private getVariablesSnapshot;
    execute(sandboxContext: SandboxContext, eventId: string): Promise<void>;
    private attachEventListeners;
    private onHttpRequest;
    private retrievePackages;
}
/**
 * This class is responsible for creating a sandbox fleet and executing scripts in it.
 */
export declare class SandboxFleetExecutor {
    private static disabledAPIs;
    private sandboxFleet?;
    private readonly queue;
    private readonly idGenerator;
    private static templateMap;
    static registerItemType(itemType: string, template: string): void;
    private init;
    private enqueue;
    private getSandbox;
    execute({ signal, variableProvider, event, itemContext, disabledAPIs, sendRequestProvider, vault, packageProvider, templateName, }: {
        signal?: AbortSignal;
        variableProvider: () => MaybePromise<Pick<ExecutionContext, 'collectionVariables' | '_variables' | 'globals' | 'environment'>>;
        event: EventHandler;
        itemContext?: ItemContext;
        disabledAPIs?: SandboxAPIs[];
        sendRequestProvider: (request: PMRequest) => Promise<PMResponse | undefined>;
        vault?: Vault;
        packageProvider?: ({ packages, }: {
            packages: Record<string, {
                id: string;
            }>;
        }) => Promise<Record<string, {
            data: string;
        }>>;
        templateName: string;
    }): Promise<Execution>;
    drainAllExecutions(): Promise<void>;
    dispose(force?: boolean): Promise<void>;
}
export declare function getSandboxFleetExecutorForRun(run: Run): SandboxFleetExecutor;
export {};
