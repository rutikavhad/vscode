"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.isVariableValues = isVariableValues;
exports.getVariablesSnapshot = getVariablesSnapshot;
exports.replaceVariables = replaceVariables;
exports.toReplacedVariables = toReplacedVariables;
const runtime_dynamic_variables_1 = require("@postman/runtime.dynamic-variables");
const key_values_1 = require("../../lib/key-values");
const objects_1 = require("../../lib/objects");
function isVariableValues(value) {
    return Array.isArray(value) && value.every(key_values_1.isKeyValue);
}
//
// #region Utilities
//
async function getVariablesSnapshot(variables) {
    const [dynamicVariables = [], workspace = [], collection = [], environment = [], local = [],] = await Promise.all([
        (0, runtime_dynamic_variables_1.getDynamicVariables)(),
        variables.workspace?.values(),
        variables.collection?.values(),
        variables.environment?.values(),
        variables.local?.values(),
    ]);
    return [
        ...dynamicVariables,
        ...workspace,
        ...collection,
        ...environment,
        ...local,
    ];
}
//
// #region Replacement
//
const VARIABLES_REGEX = /\{\{([^{}]*?)}}/g;
const MAX_REPLACEMENT_ITERATIONS = 32;
/**
 * Mutating approach to replacing variables (e.g. "{{variable_name}}") in the given input.
 */
function replaceVariables(variables, input) {
    // 1. Mutate input array
    if (Array.isArray(input)) {
        for (const [index, value] of input.entries()) {
            const replaced = replaceVariables(variables, value);
            if (replaced !== value) {
                input[index] = replaced;
            }
        }
        return input;
    }
    // 2. Mutate input object
    if ((0, objects_1.isPlainObject)(input)) {
        for (const [key, value] of Object.entries(input)) {
            const replaced = replaceVariables(variables, value);
            if (replaced !== value) {
                input[key] = replaced;
            }
        }
        return input;
    }
    // 3. Immutable replace input
    return toReplacedVariables(variables, input);
}
/**
 * Replace variables (e.g. "{{variable_name}}") in the given input.
 */
function toReplacedVariables(variables, input) {
    // 1. Map input array
    if (Array.isArray(input)) {
        const values = input.map((item) => toReplacedVariables(variables, item));
        return values;
    }
    // 2. Map input object
    if ((0, objects_1.isPlainObject)(input)) {
        const entries = [...Object.entries(input)].map(([key, value]) => [key, toReplacedVariables(variables, value)]);
        const value = Object.fromEntries(entries);
        return value;
    }
    // 3. Unsupported type, skip
    if (typeof input !== 'string') {
        return input;
    }
    const lookup = {};
    for (const variable of variables) {
        if (variable.disabled)
            continue;
        lookup[variable.key] = variable.value;
    }
    // Variable replacement is an iterative process
    // (variable values may reference other variables or nested variables)
    //
    // Places an arbitrary limit to prevent infinite loops.
    let replaced = false;
    let iterations = 0;
    const replacer = (match, token) => {
        let result = lookup[token];
        if (typeof result === 'function') {
            result = result();
        }
        if (result != null && typeof result.toString === 'function') {
            result = result.toString();
        }
        if (typeof result !== 'string') {
            // Historically, default behavior is to ignore unmatched variables
            // or variables with unsupported types
            //
            // https://github.com/postmanlabs/postman-collection/blob/d9bea02202a6e845b37b8cbf456054d8adb1e66f/lib/superstring/index.js#L230
            //
            // e.g. toReplacedVariables([], '{{a}}') = '{{a}}'
            return match;
        }
        replaced = true;
        return result;
    };
    let output = input;
    do {
        replaced = false;
        output = output.replace(VARIABLES_REGEX, replacer);
    } while (replaced && (iterations += 1) < MAX_REPLACEMENT_ITERATIONS);
    return output;
}
//# sourceMappingURL=variables.js.map